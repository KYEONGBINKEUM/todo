'use client';

import { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import { useAuth } from './auth-context';
import { getUserSettings, updateUserSettings, type Language } from './firestore';

// ============================================================================
// Translations
// ============================================================================

const translations: Record<Language, Record<string, string>> = {
  ko: {
    'nav.myDay': '오늘의 할 일',
    'nav.allTasks': '모든 작업',
    'nav.upcoming': '예정된 작업',
    'nav.notes': '노트',
    'nav.mindmap': '마인드맵',
    'nav.shared': '공유됨',
    'nav.important': '중요',
    'nav.lists': '목록',
    'nav.theme': '테마',
    'nav.themeSystem': 'OS 기본',
    'nav.themeLight': '라이트',
    'nav.themeDark': '다크',
    'common.add': '추가',
    'common.cancel': '취소',
    'common.delete': '삭제',
    'common.save': '저장',
    'common.search': '검색',
    'common.edit': '편집',
    'common.close': '닫기',
    'common.all': '전체',
    'common.loading': '로딩 중...',
    'common.confirm': '확인',
    'myDay.title': '오늘의 할 일',
    'myDay.progress': '오늘의 진행률',
    'myDay.addTask': '+ 새 작업 추가... (@태그 사용 가능)',
    'myDay.dragHint': '아이콘을 드래그하여 순서를 변경할 수 있습니다',
    'myDay.emptyAll': '오늘의 작업을 추가해보세요',
    'myDay.emptyTag': '태그의 작업이 없습니다',
    'myDay.emptyList': '이 목록에 작업이 없습니다',
    'myDay.emptyComplete': '모든 작업을 완료했습니다!',
    'tasks.title': '모든 작업',
    'tasks.search': '작업 검색...',
    'notes.title': '노트',
    'notes.search': '노트 검색...',
    'notes.newNote': '+ 새 노트 만들기',
    'notes.newFolder': '+ 새 폴더',
    'notes.selectNote': '노트를 선택하세요',
    'notes.orCreate': '또는 새 노트를 만들어보세요',
    'notes.pinned': '고정됨',
    'notes.other': '기타',
    'notes.noNotes': '노트 없음',
    'notes.newBlock': '+ 새 블록',
    'notes.shortcuts': '단축키',
    'shared.title': '공유됨',
    'shared.desc': '다른 사람과 공유된 목록을 관리하세요',
    'shared.newList': '새 공유 목록 만들기',
    'shared.invite': '이메일로 초대',
    'shared.noLists': '공유된 목록이 없습니다',
    'shared.createFirst': '새 공유 목록을 만들어 협업을 시작하세요',
    'important.title': '중요',
    'important.desc': '별표로 표시한 중요 작업 모음',
    'important.empty': '중요 작업이 없습니다',
    'important.emptyHint': '작업에서 ☆를 클릭하여 중요 표시를 추가해보세요',
    'important.unstar': '중요 해제',
    'tasks.desc': '모든 목록의 작업을 한 곳에서 관리하세요',
    'tasks.list': '목록',
    'tasks.status': '상태',
    'tasks.tags': '@태그',
    'tasks.dragHint': '필터 미적용 시 아이콘 드래그로 순서 변경',
    'tasks.empty': '작업이 없습니다',
    'tasks.emptyTag': '태그의 작업이 없습니다',
    'tasks.emptyHint': 'My Day에서 작업을 추가해보세요',
    'tasks.relatedNotes': '관련 노트',
    'tasks.dragReorder': '드래그하여 순서 변경',
    'upcoming.title': '예정된 작업',
    'upcoming.desc': '마감일이 있는 작업을 날짜별로 확인하세요',
    'upcoming.empty': '예정된 작업이 없습니다',
    'upcoming.emptyHint': '작업에 마감일을 추가해보세요',
    'upcoming.overdue': '지연됨',
    'upcoming.today': '오늘',
    'upcoming.tomorrow': '내일',
    'upcoming.thisWeek': '이번 주',
    'upcoming.thisMonth': '이번 달',
    'upcoming.later': '나중에',
    'settings.title': '설정',
    'settings.account': '계정',
    'settings.display': '표시',
    'settings.language': '언어',
    'settings.info': '정보',
    'settings.profile': '프로필',
    'settings.plan': '요금제',
    'settings.currentPlan': '현재 플랜',
    'settings.freePlan': 'Free 플랜',
    'settings.freeDesc': '기본 기능 무제한 사용',
    'settings.upgrade': 'Pro로 업그레이드',
    'settings.fontSize': '폰트 크기',
    'settings.fontSmall': '작게',
    'settings.fontMedium': '보통',
    'settings.fontLarge': '크게',
    'priority.urgent': '긴급',
    'priority.high': '높음',
    'priority.medium': '보통',
    'priority.low': '낮음',
    'status.todo': '할 일',
    'status.inProgress': '진행 중',
    'status.completed': '완료',
    'detail.title': '할일 상세',
    'detail.priority': '중요도',
    'detail.dueDate': '마감일',
    'detail.reminder': '알림',
    'detail.subTasks': '하위 할일',
    'detail.memo': '메모',
    'detail.attachments': '파일 첨부',
    'detail.status': '상태',
    'detail.delete': '할일 삭제',
    'detail.linkedNotes': '연결된 노트',
    'detail.selectNote': '노트 선택...',
    'perm.view': '보기',
    'perm.edit': '편집',
    'perm.admin': '관리자',
    'freePlan': 'Free Plan',
    'nav.tasks': '할일',
    'recurrence.label': '반복',
    'recurrence.none': '없음',
    'recurrence.daily': '매일',
    'recurrence.weekly': '매주',
    'recurrence.monthly': '매월',
    'recurrence.yearly': '매년',
    'recurrence.custom': '커스텀',
    'recurrence.interval': '반복 간격',
    'recurrence.unit.days': '일',
    'recurrence.unit.weeks': '주',
    'recurrence.unit.months': '개월',
    'recurrence.unit.years': '년',
    'recurrence.apply': '적용',
  },
  en: {
    'nav.myDay': 'My Day',
    'nav.allTasks': 'All Tasks',
    'nav.upcoming': 'Upcoming',
    'nav.notes': 'Notes',
    'nav.mindmap': 'Mind Map',
    'nav.shared': 'Shared',
    'nav.important': 'Important',
    'nav.lists': 'Lists',
    'nav.theme': 'Theme',
    'nav.themeSystem': 'System',
    'nav.themeLight': 'Light',
    'nav.themeDark': 'Dark',
    'common.add': 'Add',
    'common.cancel': 'Cancel',
    'common.delete': 'Delete',
    'common.save': 'Save',
    'common.search': 'Search',
    'common.edit': 'Edit',
    'common.close': 'Close',
    'common.all': 'All',
    'common.loading': 'Loading...',
    'common.confirm': 'Confirm',
    'myDay.title': 'My Day',
    'myDay.progress': "Today's Progress",
    'myDay.addTask': '+ Add new task... (use @tags)',
    'myDay.dragHint': 'Drag to reorder tasks',
    'myDay.emptyAll': 'Add tasks for today',
    'myDay.emptyTag': 'No tasks with this tag',
    'myDay.emptyList': 'No tasks in this list',
    'myDay.emptyComplete': 'All tasks completed!',
    'tasks.title': 'All Tasks',
    'tasks.search': 'Search tasks...',
    'notes.title': 'Notes',
    'notes.search': 'Search notes...',
    'notes.newNote': '+ Create New Note',
    'notes.newFolder': '+ New Folder',
    'notes.selectNote': 'Select a note',
    'notes.orCreate': 'or create a new one',
    'notes.pinned': 'Pinned',
    'notes.other': 'Other',
    'notes.noNotes': 'No notes',
    'notes.newBlock': '+ New Block',
    'notes.shortcuts': 'Shortcuts',
    'shared.title': 'Shared',
    'shared.desc': 'Manage shared lists with others',
    'shared.newList': 'Create Shared List',
    'shared.invite': 'Invite by email',
    'shared.noLists': 'No shared lists',
    'shared.createFirst': 'Create a shared list to start collaborating',
    'important.title': 'Important',
    'important.desc': 'Starred important tasks',
    'important.empty': 'No important tasks',
    'important.emptyHint': 'Click ☆ on a task to mark it as important',
    'important.unstar': 'Remove star',
    'tasks.desc': 'Manage all tasks from every list in one place',
    'tasks.list': 'List',
    'tasks.status': 'Status',
    'tasks.tags': '@Tags',
    'tasks.dragHint': 'Drag to reorder when no filters applied',
    'tasks.empty': 'No tasks',
    'tasks.emptyTag': 'No tasks with this tag',
    'tasks.emptyHint': 'Add tasks from My Day',
    'tasks.relatedNotes': 'Related Notes',
    'tasks.dragReorder': 'Drag to reorder',
    'upcoming.title': 'Upcoming',
    'upcoming.desc': 'View tasks with due dates by date',
    'upcoming.empty': 'No upcoming tasks',
    'upcoming.emptyHint': 'Add due dates to your tasks',
    'upcoming.overdue': 'Overdue',
    'upcoming.today': 'Today',
    'upcoming.tomorrow': 'Tomorrow',
    'upcoming.thisWeek': 'This Week',
    'upcoming.thisMonth': 'This Month',
    'upcoming.later': 'Later',
    'settings.title': 'Settings',
    'settings.account': 'Account',
    'settings.display': 'Display',
    'settings.language': 'Language',
    'settings.info': 'Info',
    'settings.profile': 'Profile',
    'settings.plan': 'Plan',
    'settings.currentPlan': 'Current Plan',
    'settings.freePlan': 'Free Plan',
    'settings.freeDesc': 'Unlimited basic features',
    'settings.upgrade': 'Upgrade to Pro',
    'settings.fontSize': 'Font Size',
    'settings.fontSmall': 'Small',
    'settings.fontMedium': 'Medium',
    'settings.fontLarge': 'Large',
    'priority.urgent': 'Urgent',
    'priority.high': 'High',
    'priority.medium': 'Medium',
    'priority.low': 'Low',
    'status.todo': 'To Do',
    'status.inProgress': 'In Progress',
    'status.completed': 'Completed',
    'detail.title': 'Task Detail',
    'detail.priority': 'Priority',
    'detail.dueDate': 'Due Date',
    'detail.reminder': 'Reminder',
    'detail.subTasks': 'Sub-tasks',
    'detail.memo': 'Memo',
    'detail.attachments': 'Attachments',
    'detail.status': 'Status',
    'detail.delete': 'Delete Task',
    'detail.linkedNotes': 'Linked Notes',
    'detail.selectNote': 'Select note...',
    'perm.view': 'View',
    'perm.edit': 'Edit',
    'perm.admin': 'Admin',
    'freePlan': 'Free Plan',
    'nav.tasks': 'Tasks',
    'recurrence.label': 'Repeat',
    'recurrence.none': 'None',
    'recurrence.daily': 'Daily',
    'recurrence.weekly': 'Weekly',
    'recurrence.monthly': 'Monthly',
    'recurrence.yearly': 'Yearly',
    'recurrence.custom': 'Custom',
    'recurrence.interval': 'Repeat interval',
    'recurrence.unit.days': 'days',
    'recurrence.unit.weeks': 'weeks',
    'recurrence.unit.months': 'months',
    'recurrence.unit.years': 'years',
    'recurrence.apply': 'Apply',
  },
  ja: {
    'nav.myDay': '今日のタスク',
    'nav.allTasks': 'すべてのタスク',
    'nav.upcoming': '予定',
    'nav.notes': 'ノート',
    'nav.mindmap': 'マインドマップ',
    'nav.shared': '共有',
    'nav.important': '重要',
    'nav.lists': 'リスト',
    'nav.theme': 'テーマ',
    'nav.themeSystem': 'システム',
    'nav.themeLight': 'ライト',
    'nav.themeDark': 'ダーク',
    'common.add': '追加',
    'common.cancel': 'キャンセル',
    'common.delete': '削除',
    'common.save': '保存',
    'common.search': '検索',
    'common.edit': '編集',
    'common.close': '閉じる',
    'common.all': 'すべて',
    'common.loading': '読み込み中...',
    'common.confirm': '確認',
    'myDay.title': '今日のタスク',
    'myDay.progress': '今日の進捗',
    'myDay.addTask': '+ 新しいタスクを追加... (@タグ使用可)',
    'myDay.dragHint': 'ドラッグして順序を変更',
    'myDay.emptyAll': '今日のタスクを追加しましょう',
    'myDay.emptyTag': 'このタグのタスクはありません',
    'myDay.emptyList': 'このリストにタスクはありません',
    'myDay.emptyComplete': 'すべてのタスクを完了しました！',
    'tasks.title': 'すべてのタスク',
    'tasks.search': 'タスクを検索...',
    'notes.title': 'ノート',
    'notes.search': 'ノートを検索...',
    'notes.newNote': '+ 新しいノート',
    'notes.newFolder': '+ 新しいフォルダ',
    'notes.selectNote': 'ノートを選択',
    'notes.orCreate': 'または新しいノートを作成',
    'notes.pinned': 'ピン留め',
    'notes.other': 'その他',
    'notes.noNotes': 'ノートなし',
    'notes.newBlock': '+ 新ブロック',
    'notes.shortcuts': 'ショートカット',
    'shared.title': '共有',
    'shared.desc': '共有リストを管理',
    'shared.newList': '共有リストを作成',
    'shared.invite': 'メールで招待',
    'shared.noLists': '共有リストなし',
    'shared.createFirst': '共有リストを作成してコラボレーションを始めましょう',
    'important.title': '重要',
    'important.desc': 'スター付きの重要なタスク',
    'important.empty': '重要なタスクはありません',
    'important.emptyHint': 'タスクの☆をクリックして重要マークを付けましょう',
    'important.unstar': '重要解除',
    'tasks.desc': 'すべてのリストのタスクを一か所で管理',
    'tasks.list': 'リスト',
    'tasks.status': 'ステータス',
    'tasks.tags': '@タグ',
    'tasks.dragHint': 'フィルタ未適用時にドラッグで順序変更',
    'tasks.empty': 'タスクなし',
    'tasks.emptyTag': 'このタグのタスクはありません',
    'tasks.emptyHint': 'My Dayからタスクを追加しましょう',
    'tasks.relatedNotes': '関連ノート',
    'tasks.dragReorder': 'ドラッグして順序変更',
    'upcoming.title': '予定',
    'upcoming.desc': '期限のあるタスクを日付別に確認',
    'upcoming.empty': '予定のタスクはありません',
    'upcoming.emptyHint': 'タスクに期限を追加しましょう',
    'upcoming.overdue': '期限切れ',
    'upcoming.today': '今日',
    'upcoming.tomorrow': '明日',
    'upcoming.thisWeek': '今週',
    'upcoming.thisMonth': '今月',
    'upcoming.later': '後で',
    'settings.title': '設定',
    'settings.account': 'アカウント',
    'settings.display': '表示',
    'settings.language': '言語',
    'settings.info': '情報',
    'settings.profile': 'プロフィール',
    'settings.plan': 'プラン',
    'settings.currentPlan': '現在のプラン',
    'settings.freePlan': 'Freeプラン',
    'settings.freeDesc': '基本機能無制限',
    'settings.upgrade': 'Proにアップグレード',
    'settings.fontSize': 'フォントサイズ',
    'settings.fontSmall': '小',
    'settings.fontMedium': '中',
    'settings.fontLarge': '大',
    'priority.urgent': '緊急',
    'priority.high': '高',
    'priority.medium': '中',
    'priority.low': '低',
    'status.todo': 'To Do',
    'status.inProgress': '進行中',
    'status.completed': '完了',
    'detail.title': 'タスク詳細',
    'detail.priority': '重要度',
    'detail.dueDate': '期限',
    'detail.reminder': 'リマインダー',
    'detail.subTasks': 'サブタスク',
    'detail.memo': 'メモ',
    'detail.attachments': '添付ファイル',
    'detail.status': 'ステータス',
    'detail.delete': 'タスクを削除',
    'detail.linkedNotes': 'リンクされたノート',
    'detail.selectNote': 'ノートを選択...',
    'perm.view': '閲覧',
    'perm.edit': '編集',
    'perm.admin': '管理者',
    'freePlan': 'Free Plan',
    'nav.tasks': 'タスク',
    'recurrence.label': '繰り返し',
    'recurrence.none': 'なし',
    'recurrence.daily': '毎日',
    'recurrence.weekly': '毎週',
    'recurrence.monthly': '毎月',
    'recurrence.yearly': '毎年',
    'recurrence.custom': 'カスタム',
    'recurrence.interval': '繰り返し間隔',
    'recurrence.unit.days': '日',
    'recurrence.unit.weeks': '週',
    'recurrence.unit.months': 'ヶ月',
    'recurrence.unit.years': '年',
    'recurrence.apply': '適用',
  },
  es: {
    'nav.myDay': 'Mi Día',
    'nav.allTasks': 'Todas las Tareas',
    'nav.upcoming': 'Próximas',
    'nav.notes': 'Notas',
    'nav.mindmap': 'Mapa Mental',
    'nav.shared': 'Compartido',
    'nav.important': 'Importante',
    'nav.lists': 'Listas',
    'nav.theme': 'Tema',
    'nav.themeSystem': 'Sistema',
    'nav.themeLight': 'Claro',
    'nav.themeDark': 'Oscuro',
    'common.add': 'Añadir',
    'common.cancel': 'Cancelar',
    'common.delete': 'Eliminar',
    'common.save': 'Guardar',
    'common.search': 'Buscar',
    'common.edit': 'Editar',
    'common.close': 'Cerrar',
    'common.all': 'Todo',
    'common.loading': 'Cargando...',
    'common.confirm': 'Confirmar',
    'myDay.title': 'Mi Día',
    'myDay.progress': 'Progreso de Hoy',
    'myDay.addTask': '+ Añadir tarea... (usa @etiquetas)',
    'myDay.dragHint': 'Arrastra para reordenar',
    'myDay.emptyAll': 'Añade tareas para hoy',
    'myDay.emptyTag': 'No hay tareas con esta etiqueta',
    'myDay.emptyList': 'No hay tareas en esta lista',
    'myDay.emptyComplete': '¡Todas las tareas completadas!',
    'tasks.title': 'Todas las Tareas',
    'tasks.search': 'Buscar tareas...',
    'notes.title': 'Notas',
    'notes.search': 'Buscar notas...',
    'notes.newNote': '+ Crear Nota',
    'notes.newFolder': '+ Nueva Carpeta',
    'notes.selectNote': 'Selecciona una nota',
    'notes.orCreate': 'o crea una nueva',
    'notes.pinned': 'Fijados',
    'notes.other': 'Otros',
    'notes.noNotes': 'Sin notas',
    'notes.newBlock': '+ Nuevo Bloque',
    'notes.shortcuts': 'Atajos',
    'shared.title': 'Compartido',
    'shared.desc': 'Gestiona listas compartidas',
    'shared.newList': 'Crear Lista Compartida',
    'shared.invite': 'Invitar por email',
    'shared.noLists': 'Sin listas compartidas',
    'shared.createFirst': 'Crea una lista compartida para empezar a colaborar',
    'important.title': 'Importante',
    'important.desc': 'Tareas marcadas como importantes',
    'important.empty': 'No hay tareas importantes',
    'important.emptyHint': 'Haz clic en ☆ para marcar una tarea como importante',
    'important.unstar': 'Quitar estrella',
    'tasks.desc': 'Gestiona todas las tareas de cada lista en un solo lugar',
    'tasks.list': 'Lista',
    'tasks.status': 'Estado',
    'tasks.tags': '@Etiquetas',
    'tasks.dragHint': 'Arrastra para reordenar sin filtros activos',
    'tasks.empty': 'Sin tareas',
    'tasks.emptyTag': 'No hay tareas con esta etiqueta',
    'tasks.emptyHint': 'Añade tareas desde Mi Día',
    'tasks.relatedNotes': 'Notas Relacionadas',
    'tasks.dragReorder': 'Arrastra para reordenar',
    'upcoming.title': 'Próximas',
    'upcoming.desc': 'Ver tareas con fecha límite por fecha',
    'upcoming.empty': 'No hay tareas próximas',
    'upcoming.emptyHint': 'Añade fechas límite a tus tareas',
    'upcoming.overdue': 'Atrasadas',
    'upcoming.today': 'Hoy',
    'upcoming.tomorrow': 'Mañana',
    'upcoming.thisWeek': 'Esta Semana',
    'upcoming.thisMonth': 'Este Mes',
    'upcoming.later': 'Después',
    'settings.title': 'Configuración',
    'settings.account': 'Cuenta',
    'settings.display': 'Pantalla',
    'settings.language': 'Idioma',
    'settings.info': 'Info',
    'settings.profile': 'Perfil',
    'settings.plan': 'Plan',
    'settings.currentPlan': 'Plan Actual',
    'settings.freePlan': 'Plan Gratis',
    'settings.freeDesc': 'Funciones básicas ilimitadas',
    'settings.upgrade': 'Actualizar a Pro',
    'settings.fontSize': 'Tamaño de Fuente',
    'settings.fontSmall': 'Pequeño',
    'settings.fontMedium': 'Mediano',
    'settings.fontLarge': 'Grande',
    'priority.urgent': 'Urgente',
    'priority.high': 'Alta',
    'priority.medium': 'Media',
    'priority.low': 'Baja',
    'status.todo': 'Pendiente',
    'status.inProgress': 'En Progreso',
    'status.completed': 'Completada',
    'detail.title': 'Detalle de Tarea',
    'detail.priority': 'Prioridad',
    'detail.dueDate': 'Fecha límite',
    'detail.reminder': 'Recordatorio',
    'detail.subTasks': 'Subtareas',
    'detail.memo': 'Notas',
    'detail.attachments': 'Archivos',
    'detail.status': 'Estado',
    'detail.delete': 'Eliminar Tarea',
    'detail.linkedNotes': 'Notas Vinculadas',
    'detail.selectNote': 'Seleccionar nota...',
    'perm.view': 'Ver',
    'perm.edit': 'Editar',
    'perm.admin': 'Admin',
    'freePlan': 'Plan Gratis',
    'nav.tasks': 'Tareas',
    'recurrence.label': 'Repetir',
    'recurrence.none': 'Ninguno',
    'recurrence.daily': 'Diario',
    'recurrence.weekly': 'Semanal',
    'recurrence.monthly': 'Mensual',
    'recurrence.yearly': 'Anual',
    'recurrence.custom': 'Personalizado',
    'recurrence.interval': 'Intervalo',
    'recurrence.unit.days': 'días',
    'recurrence.unit.weeks': 'semanas',
    'recurrence.unit.months': 'meses',
    'recurrence.unit.years': 'años',
    'recurrence.apply': 'Aplicar',
  },
  pt: {
    'nav.myDay': 'Meu Dia',
    'nav.allTasks': 'Todas as Tarefas',
    'nav.upcoming': 'Próximas',
    'nav.notes': 'Notas',
    'nav.mindmap': 'Mapa Mental',
    'nav.shared': 'Compartilhado',
    'nav.important': 'Importante',
    'nav.lists': 'Listas',
    'nav.theme': 'Tema',
    'nav.themeSystem': 'Sistema',
    'nav.themeLight': 'Claro',
    'nav.themeDark': 'Escuro',
    'common.add': 'Adicionar',
    'common.cancel': 'Cancelar',
    'common.delete': 'Excluir',
    'common.save': 'Salvar',
    'common.search': 'Buscar',
    'common.edit': 'Editar',
    'common.close': 'Fechar',
    'common.all': 'Tudo',
    'common.loading': 'Carregando...',
    'common.confirm': 'Confirmar',
    'myDay.title': 'Meu Dia',
    'myDay.progress': 'Progresso de Hoje',
    'myDay.addTask': '+ Adicionar tarefa... (use @tags)',
    'myDay.dragHint': 'Arraste para reordenar',
    'myDay.emptyAll': 'Adicione tarefas para hoje',
    'myDay.emptyTag': 'Nenhuma tarefa com esta tag',
    'myDay.emptyList': 'Nenhuma tarefa nesta lista',
    'myDay.emptyComplete': 'Todas as tarefas concluídas!',
    'tasks.title': 'Todas as Tarefas',
    'tasks.search': 'Buscar tarefas...',
    'notes.title': 'Notas',
    'notes.search': 'Buscar notas...',
    'notes.newNote': '+ Criar Nota',
    'notes.newFolder': '+ Nova Pasta',
    'notes.selectNote': 'Selecione uma nota',
    'notes.orCreate': 'ou crie uma nova',
    'notes.pinned': 'Fixados',
    'notes.other': 'Outros',
    'notes.noNotes': 'Sem notas',
    'notes.newBlock': '+ Novo Bloco',
    'notes.shortcuts': 'Atalhos',
    'shared.title': 'Compartilhado',
    'shared.desc': 'Gerencie listas compartilhadas',
    'shared.newList': 'Criar Lista Compartilhada',
    'shared.invite': 'Convidar por email',
    'shared.noLists': 'Sem listas compartilhadas',
    'shared.createFirst': 'Crie uma lista compartilhada para colaborar',
    'important.title': 'Importante',
    'important.desc': 'Tarefas marcadas como importantes',
    'important.empty': 'Nenhuma tarefa importante',
    'important.emptyHint': 'Clique em ☆ para marcar uma tarefa como importante',
    'important.unstar': 'Remover estrela',
    'tasks.desc': 'Gerencie todas as tarefas de cada lista em um só lugar',
    'tasks.list': 'Lista',
    'tasks.status': 'Status',
    'tasks.tags': '@Tags',
    'tasks.dragHint': 'Arraste para reordenar sem filtros ativos',
    'tasks.empty': 'Sem tarefas',
    'tasks.emptyTag': 'Nenhuma tarefa com esta tag',
    'tasks.emptyHint': 'Adicione tarefas do Meu Dia',
    'tasks.relatedNotes': 'Notas Relacionadas',
    'tasks.dragReorder': 'Arraste para reordenar',
    'upcoming.title': 'Próximas',
    'upcoming.desc': 'Veja tarefas com prazo por data',
    'upcoming.empty': 'Nenhuma tarefa próxima',
    'upcoming.emptyHint': 'Adicione prazos às suas tarefas',
    'upcoming.overdue': 'Atrasadas',
    'upcoming.today': 'Hoje',
    'upcoming.tomorrow': 'Amanhã',
    'upcoming.thisWeek': 'Esta Semana',
    'upcoming.thisMonth': 'Este Mês',
    'upcoming.later': 'Depois',
    'settings.title': 'Configurações',
    'settings.account': 'Conta',
    'settings.display': 'Exibição',
    'settings.language': 'Idioma',
    'settings.info': 'Info',
    'settings.profile': 'Perfil',
    'settings.plan': 'Plano',
    'settings.currentPlan': 'Plano Atual',
    'settings.freePlan': 'Plano Grátis',
    'settings.freeDesc': 'Recursos básicos ilimitados',
    'settings.upgrade': 'Atualizar para Pro',
    'settings.fontSize': 'Tamanho da Fonte',
    'settings.fontSmall': 'Pequeno',
    'settings.fontMedium': 'Médio',
    'settings.fontLarge': 'Grande',
    'priority.urgent': 'Urgente',
    'priority.high': 'Alta',
    'priority.medium': 'Média',
    'priority.low': 'Baixa',
    'status.todo': 'A Fazer',
    'status.inProgress': 'Em Progresso',
    'status.completed': 'Concluída',
    'detail.title': 'Detalhe da Tarefa',
    'detail.priority': 'Prioridade',
    'detail.dueDate': 'Data limite',
    'detail.reminder': 'Lembrete',
    'detail.subTasks': 'Subtarefas',
    'detail.memo': 'Notas',
    'detail.attachments': 'Anexos',
    'detail.status': 'Status',
    'detail.delete': 'Excluir Tarefa',
    'detail.linkedNotes': 'Notas Vinculadas',
    'detail.selectNote': 'Selecionar nota...',
    'perm.view': 'Ver',
    'perm.edit': 'Editar',
    'perm.admin': 'Admin',
    'freePlan': 'Plano Grátis',
    'nav.tasks': 'Tarefas',
    'recurrence.label': 'Repetir',
    'recurrence.none': 'Nenhum',
    'recurrence.daily': 'Diário',
    'recurrence.weekly': 'Semanal',
    'recurrence.monthly': 'Mensal',
    'recurrence.yearly': 'Anual',
    'recurrence.custom': 'Personalizado',
    'recurrence.interval': 'Intervalo',
    'recurrence.unit.days': 'dias',
    'recurrence.unit.weeks': 'semanas',
    'recurrence.unit.months': 'meses',
    'recurrence.unit.years': 'anos',
    'recurrence.apply': 'Aplicar',
  },
  fr: {
    'nav.myDay': 'Ma Journée',
    'nav.allTasks': 'Toutes les Tâches',
    'nav.upcoming': 'À Venir',
    'nav.notes': 'Notes',
    'nav.mindmap': 'Carte Mentale',
    'nav.shared': 'Partagé',
    'nav.important': 'Important',
    'nav.lists': 'Listes',
    'nav.theme': 'Thème',
    'nav.themeSystem': 'Système',
    'nav.themeLight': 'Clair',
    'nav.themeDark': 'Sombre',
    'common.add': 'Ajouter',
    'common.cancel': 'Annuler',
    'common.delete': 'Supprimer',
    'common.save': 'Enregistrer',
    'common.search': 'Rechercher',
    'common.edit': 'Modifier',
    'common.close': 'Fermer',
    'common.all': 'Tout',
    'common.loading': 'Chargement...',
    'common.confirm': 'Confirmer',
    'myDay.title': 'Ma Journée',
    'myDay.progress': "Progrès d'Aujourd'hui",
    'myDay.addTask': '+ Ajouter une tâche... (utiliser @tags)',
    'myDay.dragHint': 'Glisser pour réordonner',
    'myDay.emptyAll': "Ajoutez des tâches pour aujourd'hui",
    'myDay.emptyTag': 'Aucune tâche avec ce tag',
    'myDay.emptyList': 'Aucune tâche dans cette liste',
    'myDay.emptyComplete': 'Toutes les tâches terminées !',
    'tasks.title': 'Toutes les Tâches',
    'tasks.search': 'Rechercher des tâches...',
    'notes.title': 'Notes',
    'notes.search': 'Rechercher des notes...',
    'notes.newNote': '+ Créer une Note',
    'notes.newFolder': '+ Nouveau Dossier',
    'notes.selectNote': 'Sélectionnez une note',
    'notes.orCreate': 'ou créez-en une nouvelle',
    'notes.pinned': 'Épinglés',
    'notes.other': 'Autres',
    'notes.noNotes': 'Aucune note',
    'notes.newBlock': '+ Nouveau Bloc',
    'notes.shortcuts': 'Raccourcis',
    'shared.title': 'Partagé',
    'shared.desc': 'Gérez les listes partagées',
    'shared.newList': 'Créer une Liste Partagée',
    'shared.invite': 'Inviter par email',
    'shared.noLists': 'Aucune liste partagée',
    'shared.createFirst': 'Créez une liste partagée pour collaborer',
    'important.title': 'Important',
    'important.desc': 'Tâches marquées comme importantes',
    'important.empty': 'Aucune tâche importante',
    'important.emptyHint': 'Cliquez sur ☆ pour marquer une tâche comme importante',
    'important.unstar': 'Retirer l\'étoile',
    'tasks.desc': 'Gérez toutes les tâches de chaque liste en un seul endroit',
    'tasks.list': 'Liste',
    'tasks.status': 'Statut',
    'tasks.tags': '@Tags',
    'tasks.dragHint': 'Glissez pour réordonner sans filtres actifs',
    'tasks.empty': 'Aucune tâche',
    'tasks.emptyTag': 'Aucune tâche avec ce tag',
    'tasks.emptyHint': 'Ajoutez des tâches depuis Ma Journée',
    'tasks.relatedNotes': 'Notes Associées',
    'tasks.dragReorder': 'Glisser pour réordonner',
    'upcoming.title': 'À Venir',
    'upcoming.desc': 'Voir les tâches avec échéance par date',
    'upcoming.empty': 'Aucune tâche à venir',
    'upcoming.emptyHint': 'Ajoutez des dates limites à vos tâches',
    'upcoming.overdue': 'En Retard',
    'upcoming.today': "Aujourd'hui",
    'upcoming.tomorrow': 'Demain',
    'upcoming.thisWeek': 'Cette Semaine',
    'upcoming.thisMonth': 'Ce Mois',
    'upcoming.later': 'Plus Tard',
    'settings.title': 'Paramètres',
    'settings.account': 'Compte',
    'settings.display': 'Affichage',
    'settings.language': 'Langue',
    'settings.info': 'Info',
    'settings.profile': 'Profil',
    'settings.plan': 'Plan',
    'settings.currentPlan': 'Plan Actuel',
    'settings.freePlan': 'Plan Gratuit',
    'settings.freeDesc': 'Fonctions de base illimitées',
    'settings.upgrade': 'Passer à Pro',
    'settings.fontSize': 'Taille de Police',
    'settings.fontSmall': 'Petit',
    'settings.fontMedium': 'Moyen',
    'settings.fontLarge': 'Grand',
    'priority.urgent': 'Urgent',
    'priority.high': 'Haute',
    'priority.medium': 'Moyenne',
    'priority.low': 'Basse',
    'status.todo': 'À Faire',
    'status.inProgress': 'En Cours',
    'status.completed': 'Terminée',
    'detail.title': 'Détail de Tâche',
    'detail.priority': 'Priorité',
    'detail.dueDate': 'Date limite',
    'detail.reminder': 'Rappel',
    'detail.subTasks': 'Sous-tâches',
    'detail.memo': 'Mémo',
    'detail.attachments': 'Pièces jointes',
    'detail.status': 'Statut',
    'detail.delete': 'Supprimer la Tâche',
    'detail.linkedNotes': 'Notes Liées',
    'detail.selectNote': 'Sélectionner une note...',
    'perm.view': 'Voir',
    'perm.edit': 'Modifier',
    'perm.admin': 'Admin',
    'freePlan': 'Plan Gratuit',
    'nav.tasks': 'Tâches',
    'recurrence.label': 'Répéter',
    'recurrence.none': 'Aucun',
    'recurrence.daily': 'Quotidien',
    'recurrence.weekly': 'Hebdomadaire',
    'recurrence.monthly': 'Mensuel',
    'recurrence.yearly': 'Annuel',
    'recurrence.custom': 'Personnalisé',
    'recurrence.interval': 'Intervalle',
    'recurrence.unit.days': 'jours',
    'recurrence.unit.weeks': 'semaines',
    'recurrence.unit.months': 'mois',
    'recurrence.unit.years': 'ans',
    'recurrence.apply': 'Appliquer',
  },
};

// ============================================================================
// Language detection
// ============================================================================

const LANGUAGE_NAMES: Record<Language, string> = {
  ko: '한국어',
  en: 'English',
  ja: '日本語',
  es: 'Español',
  pt: 'Português',
  fr: 'Français',
};

function detectLanguageFromBrowser(): Language {
  if (typeof navigator === 'undefined') return 'ko';
  const lang = navigator.language || (navigator as { userLanguage?: string }).userLanguage || 'ko';
  const code = lang.split('-')[0].toLowerCase();
  if (code in translations) return code as Language;
  return 'ko';
}

async function detectLanguageFromIP(): Promise<Language | null> {
  try {
    const res = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(3000) });
    if (!res.ok) return null;
    const data = await res.json();
    const countryLangMap: Record<string, Language> = {
      KR: 'ko', KP: 'ko',
      US: 'en', GB: 'en', AU: 'en', CA: 'en', NZ: 'en', IE: 'en', ZA: 'en', IN: 'en',
      JP: 'ja',
      ES: 'es', MX: 'es', AR: 'es', CO: 'es', CL: 'es', PE: 'es', VE: 'es', EC: 'es',
      BR: 'pt', PT: 'pt', AO: 'pt', MZ: 'pt',
      FR: 'fr', BE: 'fr', CH: 'fr', LU: 'fr', MC: 'fr', SN: 'fr', CI: 'fr', CM: 'fr',
    };
    return countryLangMap[data.country_code] || null;
  } catch {
    return null;
  }
}

// ============================================================================
// Context
// ============================================================================

interface I18nContextType {
  language: Language;
  setLanguage: (lang: Language) => void;
  t: (key: string) => string;
  languageNames: Record<Language, string>;
}

const I18nContext = createContext<I18nContextType>({
  language: 'ko',
  setLanguage: () => {},
  t: (key) => key,
  languageNames: LANGUAGE_NAMES,
});

export function I18nProvider({ children }: { children: ReactNode }) {
  const { user } = useAuth();
  const [language, setLanguageState] = useState<Language>('ko');
  const [initialized, setInitialized] = useState(false);

  // Load language from settings, fallback to IP/browser detection
  useEffect(() => {
    if (!user) return;
    getUserSettings(user.uid).then(async (settings) => {
      if (settings.language) {
        setLanguageState(settings.language);
      } else {
        // Auto-detect: try IP first, then browser
        const ipLang = await detectLanguageFromIP();
        const detectedLang = ipLang || detectLanguageFromBrowser();
        setLanguageState(detectedLang);
        updateUserSettings(user.uid, { language: detectedLang });
      }
      setInitialized(true);
    });
  }, [user]);

  // For non-logged-in users, detect from browser
  useEffect(() => {
    if (user) return;
    const lang = detectLanguageFromBrowser();
    setLanguageState(lang);
    setInitialized(true);
  }, [user]);

  const setLanguage = (lang: Language) => {
    setLanguageState(lang);
    if (user) updateUserSettings(user.uid, { language: lang });
  };

  const t = (key: string): string => {
    return translations[language]?.[key] || translations.ko[key] || key;
  };

  return (
    <I18nContext.Provider value={{ language, setLanguage, t, languageNames: LANGUAGE_NAMES }}>
      {children}
    </I18nContext.Provider>
  );
}

export const useI18n = () => useContext(I18nContext);
export { LANGUAGE_NAMES };
export type { Language as I18nLanguage };
