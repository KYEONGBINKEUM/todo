<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Todo - Google Login</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #08081a; color: #e2e8f0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
  .card { background: #111128; border: 1px solid #1e1e3a; border-radius: 16px; padding: 48px 32px; text-align: center; max-width: 400px; width: 90%; }
  h1 { font-size: 28px; margin-bottom: 8px; background: linear-gradient(to right, #e2e8f0, #e94560); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  p { color: #94a3b8; margin-bottom: 24px; font-size: 14px; }
  .spinner { width: 40px; height: 40px; border: 3px solid #1e1e3a; border-top-color: #e94560; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 24px auto; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error { color: #ef4444; margin-top: 16px; font-size: 13px; }
  .success { color: #34d399; }
  #status { margin-top: 16px; font-size: 13px; color: #94a3b8; }
</style>
</head>
<body>
<div class="card">
  <h1>AI Todo</h1>
  <p>Google 계정으로 로그인 중...</p>
  <div class="spinner" id="spinner"></div>
  <div id="status">잠시만 기다려주세요</div>
  <div class="error" id="error"></div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
(async function() {
  var params = new URLSearchParams(location.search);
  var config = {
    apiKey: params.get('apiKey'),
    authDomain: params.get('authDomain'),
    projectId: params.get('projectId'),
  };
  var statusEl = document.getElementById('status');
  var errorEl = document.getElementById('error');
  var spinnerEl = document.getElementById('spinner');

  if (!config.apiKey || !config.authDomain || !config.projectId) {
    spinnerEl.style.display = 'none';
    errorEl.textContent = '앱 설정 오류: Firebase 설정값이 없습니다.';
    return;
  }

  try {
    firebase.initializeApp(config);
    var auth = firebase.auth();
    var provider = new firebase.auth.GoogleAuthProvider();

    // 리다이렉트 결과 확인 (Google 로그인 후 돌아왔을 때)
    statusEl.textContent = '로그인 정보를 확인하는 중...';
    var result = await auth.getRedirectResult();

    if (result && result.user) {
      // 리다이렉트 후 로그인 성공
      var user = result.user;
      statusEl.textContent = '인증 정보를 앱으로 전달하는 중...';

      var accessToken = await user.getIdToken(true);

      var userData = {
        uid: user.uid,
        email: user.email,
        emailVerified: user.emailVerified,
        displayName: user.displayName,
        isAnonymous: user.isAnonymous,
        photoURL: user.photoURL,
        providerData: user.providerData.map(function(p) {
          return {
            providerId: p.providerId,
            uid: p.uid,
            displayName: p.displayName,
            email: p.email,
            phoneNumber: p.phoneNumber,
            photoURL: p.photoURL
          };
        }),
        stsTokenManager: {
          refreshToken: user.refreshToken,
          accessToken: accessToken,
          expirationTime: Date.now() + 3600 * 1000
        },
        createdAt: String(new Date(user.metadata.creationTime).getTime()),
        lastLoginAt: String(new Date(user.metadata.lastSignInTime).getTime()),
        apiKey: config.apiKey,
        appName: '[DEFAULT]'
      };

      // Base64 인코딩하여 딥링크로 전달
      var encoded = btoa(unescape(encodeURIComponent(JSON.stringify(userData))));

      spinnerEl.style.display = 'none';
      statusEl.innerHTML = '<span class="success">&#10003; 로그인 완료!</span><br><br>앱으로 돌아가는 중...';

      // 딥링크로 앱에 인증 데이터 전달
      window.location.href = 'aitodo://auth-callback#data=' + encoded;

      // 3초 후에도 리다이렉트 안되면 안내 표시
      setTimeout(function() {
        statusEl.innerHTML = '<span class="success">&#10003; 로그인 완료!</span><br><br>AI Todo 앱으로 돌아가주세요.';
      }, 3000);

    } else {
      // 로그인 시작: Google로 리다이렉트
      statusEl.textContent = 'Google 로그인 페이지로 이동 중...';
      await auth.signInWithRedirect(provider);
    }

  } catch (err) {
    spinnerEl.style.display = 'none';
    statusEl.textContent = '';
    errorEl.textContent = '로그인 실패: ' + (err.message || String(err));
    console.error(err);
  }
})();
</script>
</body>
</html>
